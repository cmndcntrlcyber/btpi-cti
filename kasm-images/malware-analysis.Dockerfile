# Name: CTI Malware Analysis Workspace
# Description: Specialized workspace for malware analysis and reverse engineering
# Category: Security

FROM kasmweb/core-ubuntu-focal:1.12.0
USER root

ENV HOME /home/kasm-default-profile
ENV STARTUPDIR /dockerstartup
ENV INST_SCRIPTS $STARTUPDIR/install
WORKDIR $HOME

# Install common tools
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    python3-pip \
    python3-venv \
    build-essential \
    unzip \
    file \
    binutils \
    strace \
    ltrace \
    && apt-get clean

# Install analysis tools
RUN apt-get update && apt-get install -y \
    radare2 \
    gdb \
    hexedit \
    xxd \
    yara \
    && apt-get clean

# Install Ghidra
RUN mkdir -p /opt/ghidra && \
    wget -q -O /tmp/ghidra.zip https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_10.1.2_build/ghidra_10.1.2_PUBLIC_20220125.zip && \
    unzip /tmp/ghidra.zip -d /opt && \
    rm /tmp/ghidra.zip && \
    mv /opt/ghidra_* /opt/ghidra && \
    chmod +x /opt/ghidra/ghidraRun

# Install Python analysis tools
RUN pip3 install --no-cache-dir \
    pefile \
    pyelftools \
    capstone \
    r2pipe \
    yara-python \
    volatility3

# Install VirusTotal CLI
RUN pip3 install --no-cache-dir \
    vt-cli

# Create desktop shortcuts
RUN mkdir -p $HOME/Desktop
COPY ./resources/shortcuts/ghidra.desktop $HOME/Desktop/
COPY ./resources/shortcuts/radare2.desktop $HOME/Desktop/
COPY ./resources/shortcuts/virustotal.desktop $HOME/Desktop/

# Add sandbox warning
RUN echo "WARNING: This is a malware analysis environment. Do not use for general browsing or other activities." > $HOME/Desktop/SANDBOX_WARNING.txt

# Set permissions
RUN chmod +x $HOME/Desktop/*.desktop && \
    chown -R 1000:1000 $HOME

# Switch back to default user
USER 1000
